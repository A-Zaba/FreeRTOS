name: FreeRTOS Demos
on:
  push:
  pull_request:
  workflow_dispatch:

env:
  # The bash escape character is \033
  bashPass:   \033[32;1m
  bashWarn:   \033[33;1m
  bashFail:   \033[31;1m
  bashEnd:    \033[0m

  # The powershell escape character is `e
  pwshPass:   '`e[32;1m'
  pwshWarn:   '`e[33;1m'
  pwshFail:   '`e[31;1m'
  pwshEnd:    '`e[0m'


jobs:
  WIN32-MSVC:
    name: WIN32 MSVC
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Test Windows Bash Colours
        id: test-windows-bash-colours
        shell: bash
        run: |
          # Test Windows Bash Colours
          echo -e "${{ env.bashPass }} Test Windows Bash Pass Colour     ${{ env.bashEnd }}"
          echo -e "${{ env.bashWarn }} Test Windows Bash Warning Colour  ${{ env.bashEnd }}"
          echo -e "${{ env.bashFail }} Test Windows Bash Fail Colour     ${{ env.bashEnd }}"
          
      - name: Test Windows Pwsh Colours
        id: test-windows-pwsh-colours
        run: |
          # Test Windows Powershell Colours
          echo "${{ env.pwshPass }}Test Windows Bash Pass Colour     ${{ env.pwshEnd }}"
          echo "${{ env.pwshWarn }}Test Windows Bash Warning Colour  ${{ env.pwshEnd }}"
          echo "${{ env.pwshFail }}Test Windows Bash Fail Colour     ${{ env.pwshEnd }}"

      - name: Fetch Kernel Submodule
        shell: bash
        run: |
          # Fetch Kernel Submodule
          echo "::group::Fetch Kernel Submodule"
          set +e
          git submodule update --checkout --init --depth 1 FreeRTOS/Source
          exitStatus=$?
          set -e
          echo "::endgroup::"
          if [[ "$exitStatus" = "0" ]]; then
            echo -e "${{ env.bashPass }}Fetch Kernel Submodule Passed${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Fetch Kernel Submodule Failed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v1.1

      - name: Build WIN32-MSVC Full Demo
        id: build-win32-msvs-full-demo
        working-directory: FreeRTOS/Demo/WIN32-MSVC
        run: |
          # Build WIN32-MSVC Full Demo
          echo "::group::Build WIN32-MSVC Full Demo"
          $content = Get-Content -Path 'main.c' -Raw
          $newContent = $content -replace 'int\s+main(.*?)void(.*?)\r?\n\s*{', 'int main( void ){setvbuf( stdout, NULL, _IONBF, 0 );'
          msbuild WIN32.sln -t:rebuild
          $exitStatus = $?
          echo "::endgroup::"
          if($exitStatus -eq 1) {
            echo "${{ env.pwshPass }}Build WIN32-MSVC Full Demo Passed${{ env.pwshEnd }}"
          }else {
            echo "${{ env.pwshFail }}Build WIN32-MSVC Full Demo Failed...${{ env.pwshEnd }}"
            exit 1
          }

      - name: Run and monitor WIN32-MSVC Full Demo
        uses: FreeRTOS/CI-CD-GitHub-Actions/executable-monitor@main
        with:
          exe-path: FreeRTOS/Demo/WIN32-MSVC/Debug/RTOSDemo.exe
          log-dir: demo_run_logs
          timeout-seconds: 60
          success-line: "No errors - tick count"

      - name: Build WIN32-MSVC Blinky Demo
        id: build-win32-msvs-blinky-demo
        working-directory: FreeRTOS/Demo/WIN32-MSVC
        run: |
          # Build WIN32-MSVC Blinky Demo
          echo "::group::MSBuild of WIN32-MSVC Blinky Demo"
          $content = Get-Content -Path 'main.c' -Raw
          $newContent = $content -replace '#define\s+mainCREATE_SIMPLE_BLINKY_DEMO_ONLY\s+0', '#define mainCREATE_SIMPLE_BLINKY_DEMO_ONLY    1'
          $newContent | Set-Content -Path 'main.c'
          # Perform MSBuild of WIN32-MSVC Blinky Demo
          msbuild WIN32.sln -t:rebuild
          $exitStatus = $?
          if($exitStatus -eq 1) {
            echo "${{ env.pwshPass }}Build WIN32-MSVC Blinky Demo ${{ env.pwshEnd }}"
          }else {
            echo "${{ env.pwshFail }}Build WIN32-MSVC Blinky Demo Failed...${{ env.pwshEnd }}"
            exit 1
          }

      - name: Run and monitor WIN32-MSVC Blinky Demo
        uses: FreeRTOS/CI-CD-GitHub-Actions/executable-monitor@main
        with:
          exe-path: FreeRTOS/Demo/WIN32-MSVC/Debug/RTOSDemo.exe
          log-dir: demo_run_logs
          timeout-seconds: 60
          success-line: "Message received from software timer"

      - name: Build WIN32-MSVC-Static-Allocation-Only Demo
        id: build-win32-msvs-static-allocation-only-demo
        working-directory: FreeRTOS/Demo/WIN32-MSVC-Static-Allocation-Only
        run: |
          # Build WIN32-MSVC-Static-Allocation-Only Demo
          echo "::group::Build WIN32-MSVC-Static-Allocation-Only Demo"
          $content = Get-Content -Path 'main.c' -Raw
          $newContent = $content -replace 'int\s+main(.*?)void(.*?)\r?\n\s*{', 'int main( void ){setvbuf( stdout, NULL, _IONBF, 0 );'
          $newContent | Set-Content -Path 'main.c'
          msbuild WIN32.sln -t:rebuild
          exitStatus=$?
          echo "::endgroup::"
          if($exitStatus -eq 1) {
            echo "${{ env.pwshPass }}Built the WIN32-MSVC-Static-Allocation-Only Demo${{ env.pwshEnd }}"
          }else {
            echo "${{ env.pwshFail }}Build WIN32-MSVC-Static-Allocation-Only Demo Failed...${{ env.pwshEnd }}"
            exit 1
          }

      - name: Run and monitor WIN32-MSVC-Static-Allocation-Only Demo
        uses: FreeRTOS/CI-CD-GitHub-Actions/executable-monitor@main
        with:
          exe-path: FreeRTOS/Demo/WIN32-MSVC-Static-Allocation-Only/Debug/RTOSDemo.exe
          log-dir: demo_run_logs
          timeout-seconds: 60
          success-line: "No errors - tick count"

  WIN32-MingW:
    name: WIN32 MingW
    runs-on: windows-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch Kernel Submodule
        shell: bash
        run: |
          # Fetch Kernel Submodule
          echo "::group::Fetch Kernel Submodule"
          set +e
          git submodule update --checkout --init --depth 1 FreeRTOS/Source
          exitStatus=$?
          echo "::endgroup::"
          if [[ "$exitStatus" = "0" ]]; then
            echo -e "${{ env.bashPass }}Fetch Kernel Submodule Passed${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Fetch Kernel Submodule Failed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Build WIN32-MingW Full Demo
        id: build-win32-mingw-full-demo
        working-directory: FreeRTOS/Demo/WIN32-MingW
        run: |
          # Build WIN32-MingW Full Demo
          echo "::group::Build WIN32-MingW Full Demo"
          $content = Get-Content -Path 'main.c' -Raw
          $newContent = $content -replace 'int\s+main(.*?)void(.*?)\r?\n\s*{', 'int main( void ){setvbuf( stdout, NULL, _IONBF, 0 );'
          $newContent | Set-Content -Path 'main.c'
          gcc --version
          make --version
          make
          $exitStatus = $?
          echo "::endgroup::"
          if($exitStatus -eq 1) {
            echo "${{ env.pwshPass }}Built the WIN32-MingW Full Demo ${{env.pwshEnd}}"
          }else {
            echo "${{ env.pwshFail }}Build WIN32-MingW Full Demo Failed...${{env.pwshEnd}}"
            exit 1
          }

      - name: Run and monitor WIN32-MingW Full Demo
        uses: FreeRTOS/CI-CD-GitHub-Actions/executable-monitor@main
        with:
          exe-path: FreeRTOS/Demo/WIN32-MingW/build/RTOSDemo.exe
          log-dir: demo_run_logs
          timeout-seconds: 60
          success-line: "No errors - tick count"

      - name: Build WIN32-MingW Blinky Demo
        id: build-win32-mingw-blinky-demo
        working-directory: FreeRTOS/Demo/WIN32-MingW
        run: |
          # Build WIN32-MingW Blinky Demo
          echo "::group::Build WIN32-MingW Blinky Demo"
          $content = Get-Content -Path 'main.c' -Raw
          $newContent = $content -replace '#define\s+mainCREATE_SIMPLE_BLINKY_DEMO_ONLY\s+0', '#define mainCREATE_SIMPLE_BLINKY_DEMO_ONLY    1'
          $newContent = $newContent -replace 'int\s+main(.*?)void(.*?)\r?\n\s*{', 'int main( void ){setvbuf( stdout, NULL, _IONBF, 0 );'
          $newContent | Set-Content -Path 'main.c'
          gcc --version
          make --version
          make
          $exitStatus = $?
          echo "::endgroup::"
          if($exitStatus -eq 1) {
            echo "${{ env.pwshPass }}Built the WIN32-MingW Blinky Demo${{ env.pwshEnd }}"
          }else {
            echo "${{ env.pwshFail }}Build WIN32-MingW Blinky Demo Failed...${{ env.pwshEnd }}"
            exit 1
          }

      - name: Run and monitor WIN32-MingW Blinky Demo
        uses: FreeRTOS/CI-CD-GitHub-Actions/executable-monitor@main
        with:
          exe-path: FreeRTOS/Demo/WIN32-MingW/build/RTOSDemo.exe
          log-dir: demo_run_logs
          timeout-seconds: 60
          success-line: "Message received from software timer"

  POSIX-GCC:
    name: Posix GCC
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Test Posix Bash Colours
        id: test-posix-bash-colours
        run: |
          # Test Posix Bash Colours
          echo -e "${{ env.bashPass }}Test Posix Bash Pass Colour     ${{ env.bashEnd }}"
          echo -e "${{ env.bashWarn }}Test Posix Bash Warning Colour  ${{ env.bashEnd }}"
          echo -e "${{ env.bashFail }}Test Posix Bash Fail Colour     ${{ env.bashEnd }}"

      - name: Fetch Kernel Submodule
        shell: bash
        run: |
          # Fetch Kernel Submodule
          echo "::group::Fetch Kernel Submodule"
          set +e
          git submodule update --checkout --init --depth 1 FreeRTOS/Source
          exitStatus=$?
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Fetch Kernel Submodule Passed${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Fetch Kernel Submodule Failed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Install GCC
        shell: bash
        run: |
          # Install GCC
          echo "::group::Install GCC"
          set +e
          sudo apt-get -y update
          sudo apt-get -y install build-essential
          exitStatus=$?
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Install GCC Passed${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashPass }}Install GCC Failed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Build Posix_GCC Full Demo
        id: build-posix-gcc-full-demo
        shell: bash
        working-directory: FreeRTOS/Demo/Posix_GCC
        run: |
          # Build Posix_GCC Full Demo
          echo "::group::Build Posix_GCC Full Demo"
          set +e
          sed -i -z "s/int[[:space:]]*main[[:space:]]*([[:space:]]*void[[:space:]]*)\n{/int main( void ){setvbuf( stdout, NULL, _IONBF, 0 );/g" main.c
          make -j
          exitStatus=$?
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Build Posix_GCC Full Demo Passed${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Build Posix_GCC Full Demo Failed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Run and monitor Posix_GCC Full Demo
        uses: FreeRTOS/CI-CD-GitHub-Actions/executable-monitor@main
        with:
          exe-path: FreeRTOS/Demo/Posix_GCC/build/posix_demo
          log-dir: demo_run_logs
          timeout-seconds: 60
          success-line: "OK: No errors"

      - name: Build Posix_GCC Blinky Demo
        id: build-posix-gcc-blinky-demo
        shell: bash
        working-directory: FreeRTOS/Demo/Posix_GCC
        run: |
          # Build Posix_GCC Blinky Demo
          echo "::group::Build Posix_GCC Blinky Demo"
          rm -rf build
          set +e
          make -j USER_DEMO=BLINKY_DEMO
          exitStatus=$?
          echo "::endgroup::"
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Built the Posix_GCC Blinky Demo${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Build Posix_GCC Blinky Demo Failed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Run and monitor Posix_GCC Blinky Demo
        uses: FreeRTOS/CI-CD-GitHub-Actions/executable-monitor@main
        with:
          exe-path: FreeRTOS/Demo/Posix_GCC/build/posix_demo
          log-dir: demo_run_logs
          timeout-seconds: 60
          success-line: "Message received from software timer"

  MSP430-GCC:
    name: GNU MSP430 Toolchain
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch Kernel Submodule
        shell: bash
        run: |
          # Fetch Kernel Submodule
          echo "::group::Fetch Kernel Submodule"
          set +e
          git submodule update --checkout --init --depth 1 FreeRTOS/Source
          exitStatus=$?
          echo "::endgroup::"
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Fetch Kernel Submodule Passed${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Fetch Kernel Submodule Failed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Install MSP430 Toolchain
        shell: bash
        run: |
          # Install MSP430 Toolchain
          echo "::group::Install MSP430 Toolchain"
          set +e
          sudo apt-get -y update
          sudo apt-get -y install gcc-msp430 build-essential
          exitStatus=$?
          echo "::endgroup::"
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Installed the MSP430 Toolchain${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Installing the MSP430 ToolchainFailed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Build msp430_GCC Demo
        shell: bash
        working-directory: FreeRTOS/Demo/msp430_GCC
        run: |
          # Build msp430_GCC Demo
          echo "::group::Build msp430_GCC Demo"
          set +e
          make -j
          exitStatus=$?
          echo "::endgroup::"
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Built the msp430_GCC Demo${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Building the msp430_GCC Demo Failed...${{ env.bashEnd }}"
            exit 1
          fi

  ARM-GCC:
    name: GNU ARM Toolchain
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Fetch Kernel Submodule
        shell: bash
        run: |
          # Fetch Kernel Submodule
          echo "::group::Fetch Kernel Submodule"
          set +e
          git submodule update --checkout --init --depth 1 FreeRTOS/Source FreeRTOS/Demo/ThirdParty/Community-Supported-Demos
          exitStatus=$?
          echo "::endgroup::"
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Fetch Kernel Submodule Passed${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Fetch Kernel Submodule Failed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Install GNU ARM Toolchain
        shell: bash
        run: |
          # Install GNU ARM Toolchain
          echo "::group::Install GNU ARM Toolchain"
          set +e
          sudo apt-get -y update
          sudo apt-get -y install gcc-arm-none-eabi build-essential cmake git ninja-build python3-minimal
          exitStatus=$?
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Install GNU ARM Toolchain${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Install GNU ARM Toolchain Failed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Build CORTEX_MPU_M3_MPS2_QEMU_GCC Demo
        shell: bash
        working-directory: FreeRTOS/Demo/CORTEX_MPU_M3_MPS2_QEMU_GCC
        run: |
          # Build CORTEX_MPU_M3_MPS2_QEMU_GCC Demo
          echo "::group::Build CORTEX_MPU_M3_MPS2_QEMU_GCC Demo"
          set +e
          make -j
          exitStatus=$?
          echo "::endgroup::"
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Build CORTEX_MPU_M3_MPS2_QEMU_GCC Demo${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Build CORTEX_MPU_M3_MPS2_QEMU_GCC Demo Failed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Build CORTEX_LM3S102_GCC Demo
        shell: bash
        working-directory: FreeRTOS/Demo/CORTEX_LM3S102_GCC
        run: |
          # Build CORTEX_LM3S102_GCC Demo
          echo "::group::Build CORTEX_LM3S102_GCC Demo"
          set +e
          make -j
          exitStatus=$?
          echo "::endgroup::"
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Built the CORTEX_LM3S102_GCC Demo Kernel${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Build CORTEX_LM3S102_GCC Demo Failed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Build CORTEX_M3_MPS2_QEMU_GCC Demo
        shell: bash
        working-directory: FreeRTOS/Demo/CORTEX_M3_MPS2_QEMU_GCC
        run: |
          # Build CORTEX_M3_MPS2_QEMU_GCC Demo
          echo "::group::Build CORTEX_M3_MPS2_QEMU_GCC Demo"
          set +e
          make clean
          make -j
          exitStatus=$?
          echo "::endgroup::"
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Built the CORTEX_M3_MPS2_QEMU_GCC Demo${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Build CORTEX_M3_MPS2_QEMU_GCC Demo Failed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Build CORTEX_M3_MPS2_QEMU_GCC Full Demo
        shell: bash
        working-directory: FreeRTOS/Demo/CORTEX_M3_MPS2_QEMU_GCC
        run: |
         # Build CORTEX_M3_MPS2_QEMU_GCC Full Demo
          echo "::group::Build CORTEX_M3_MPS2_QEMU_GCC Full Demo"
          set +e
          make clean
          make FULL_DEMO=1 -j
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Built the CORTEX_M3_MPS2_QEMU_GCC Full Demo${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Build CORTEX_M3_MPS2_QEMU_GCC Full Demo Failed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Build CORTEX_LM3S811_GCC Demo
        shell: bash
        working-directory: FreeRTOS/Demo/CORTEX_LM3S811_GCC
        run: |
          # Build CORTEX_LM3S811_GCC Demo
          echo "::group::Build CORTEX_LM3S811_GCC Demo"
          set +e
          make -j
          exitStatus=$?
          echo "::endgroup::"
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Built the CORTEX_LM3S811_GCC Demo${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Build CORTEX_LM3S811_GCC Demo Failed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Build CORTEX_M0+_RP2040 Demos
        shell: bash
        working-directory: FreeRTOS/Demo/Community-Supported-Demos/CORTEX_M0+_RP2040
        run: |
          # Build CORTEX_M0+_RP2040 Demos
          echo "::group::Build CORTEX_M0+_RP2040 Demos"
          set +e
          git clone https://github.com/raspberrypi/pico-sdk.git
          cmake -B build -DPICO_SDK_PATH=pico-sdk -GNinja
          ninja -C build --verbose
          exitStatus=$?
          echo "::endgroup::"
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Built CORTEX_M0+_RP2040 Demos${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Build CORTEX_M0+_RP2040 Demos Failed...${{ env.bashEnd }}"
            exit 1
          fi

      - name: Build CORTEX_MPS2_QEMU_IAR_GCC Demo
        shell: bash
        working-directory: FreeRTOS/Demo/CORTEX_MPS2_QEMU_IAR_GCC
        run: |
          # Build CORTEX_MPS2_QEMU_IAR_GCC Demo
          echo "::group::Build CORTEX_MPS2_QEMU_IAR_GCC Demo"
          set +e
          make -C build/gcc -j
          exitStatus=$?
          echo "::endgroup::"
          if [ "$exitStatus" = "0" ]; then
            echo -e "${{ env.bashPass }}Built the CORTEX_MPS2_QEMU_IAR_GCC Demo${{ env.bashEnd }}"
          else
            echo -e "${{ env.bashFail }}Build CORTEX_MPS2_QEMU_IAR_GCC Demo Failed...${{ env.bashEnd }}"
            exit 1
          fi
